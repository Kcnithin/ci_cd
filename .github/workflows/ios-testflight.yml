name: iOS - Build & Upload to TestFlight (master)

on:
  workflow_dispatch:
    inputs:
      changelog:
        description: "Optional changelog shown in TestFlight"
        required: false
        default: "New build from GitHub Actions"
      dart_define:
        description: "Optional --dart-define key=value (comma-separated). Example: ENV=prod,FOO=bar"
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-upload:
    runs-on: macos-latest
    name: Build IPA & Upload to TestFlight

    env:
      TEAM_ID: "RMG82888A2"
      BUNDLE_ID: "com.amagi.customerdev"
      SCHEME: "Runner"

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable
          cache: true

      - name: Install dependencies
        run: |
          flutter pub get
          cd ios && pod install --repo-update && cd ..

      - name: Create keychain & import signing certificate
        env:
          CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$CERT_BASE64" | base64 --decode > ios_dist.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import ios_dist.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychain -d user -s build.keychain
          security default-keychain -s build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Install provisioning profile
        env:
          PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$HOME/Library/MobileDevice/Provisioning Profiles/build.mobileprovision"
          echo "$PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< $(security cms -D -i "$PROFILE_PATH"))
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"

      - name: Create ExportOptions.plist
        run: |
          cat > ios/ExportOptions.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${{ env.TEAM_ID }}</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ env.BUNDLE_ID }}</key><string>${{ env.PROFILE_UUID }}</string>
            </dict>
          </dict>
          </plist>
          PLIST

      - name: Flutter build (no codesign)
        run: |
          DART_ARGS=""
          if [ -n "${{ inputs.dart_define }}" ]; then
            IFS=',' read -ra ADDR <<< "${{ inputs.dart_define }}"
            for i in "${ADDR[@]}"; do DART_ARGS="$DART_ARGS --dart-define=$i"; done
          fi
          # Automatically increments build number for TestFlight uniqueness
          flutter build ios --release --no-codesign --build-number=${{ github.run_number }} $DART_ARGS

      - name: Archive & Export IPA
        run: |
          xcodebuild -workspace ios/Runner.xcworkspace -scheme "${SCHEME}" -configuration Release -archivePath build/ios/Runner.xcarchive archive CODE_SIGNING_ALLOWED=NO
          xcodebuild -exportArchive -archivePath build/ios/Runner.xcarchive -exportPath build/ios/ipa -exportOptionsPlist ios/ExportOptions.plist CODE_SIGNING_ALLOWED=YES

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Upload to TestFlight
        env:
          # REQUIRED: Exact variable names for Fastlane API authentication
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.ASC_KEY_CONTENT }}
          APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: true

          # FORCE API KEY MODE
          FASTLANE_USER: "api_key"
          FASTLANE_SKIP_CONFIRMATIONS: "true"
          FASTLANE_SKIP_UPDATE_CHECK: "true"
          FASTLANE_SESSION: ""
        run: |
          gem install fastlane
          fastlane pilot upload \
            --ipa build/ios/ipa/*.ipa \
            --skip_waiting_for_build_processing true \
            --changelog "${{ inputs.changelog }}"
