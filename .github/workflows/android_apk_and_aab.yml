name: Android - Build Signed (APK or AAB) - Windows

on:
  workflow_dispatch:
    inputs:
      build_format:
        description: "Choose build output: apk or aab"
        required: true
        default: "apk"
      dart_define:
        description: "Optional --dart-define key=value (comma-separated). Example: ENV=prod,FOO=bar"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build-android:
    runs-on: windows-latest
    name: Build Signed ${{ inputs.build_format }} on Windows

    env:
      PACKAGE_NAME: "com.example.sample_ci_cd"

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set up Java 17 (AGP compatible)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Flutter 3.38.9
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable

      - name: Flutter clean
        shell: powershell
        run: flutter clean

      - name: Flutter pub get
        shell: powershell
        run: flutter pub get

      - name: Ensure android folder exists
        shell: powershell
        run: |
          if (-not (Test-Path "android/app/build.gradle") -and -not (Test-Path "android/app/build.gradle.kts")) {
            flutter create .
          }

      - name: Read version from pubspec.yaml
        shell: powershell
        run: |
          $pub = "pubspec.yaml"
          if (!(Test-Path $pub)) { Write-Error "pubspec.yaml not found"; exit 1 }
          
          $content = Get-Content -Raw -Path $pub
          $regex = [regex]'(?m)^\s*version:\s*([0-9]+\.[0-9]+\.[0-9]+\+[0-9]+)\s*$'
          
          if (-not $regex.IsMatch($content)) {
            Write-Error "version: x.y.z+build not found in pubspec.yaml"
            exit 1
          }
          
          $version = $regex.Match($content).Groups[1].Value
          
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Using version from pubspec.yaml: $version"

      # -----------------------------
      # Signing setup (Upload keystore)
      # -----------------------------
      - name: Decode & save keystore
        shell: powershell
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          New-Item -ItemType Directory -Force -Path "android\keystores" | Out-Null
          $bytes = [Convert]::FromBase64String($env:ANDROID_KEYSTORE_BASE64)
          $keystorePath = Resolve-Path "android\keystores"
          $keystoreFile = "$keystorePath\cicd-keystore.jks"
          [IO.File]::WriteAllBytes($keystoreFile, $bytes)
          
          # Export absolute path for subsequent steps
          "ANDROID_KEYSTORE_PATH=$keystoreFile" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Get-ChildItem "android\keystores"


      - name: Create key.properties at repo root (Kotlin DSL signing)
        shell: powershell
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          $props = @"
          storeFile=../keystores/cicd-keystore.jks
          storePassword=$env:ANDROID_KEYSTORE_PASSWORD
          keyAlias=$env:ANDROID_KEY_ALIAS
          keyPassword=$env:ANDROID_KEY_ALIAS_PASSWORD
          "@
                  # The file must be at the android root so android/app/build.gradle finds it
                  $props | Set-Content -Path "android/key.properties" -Encoding UTF8
          Write-Host "Wrote android/key.properties"

      - name: Debug signing files
        shell: powershell
        run: |
          Write-Host "Checking android/key.properties..."
          if (Test-Path "android/key.properties") {
            Write-Host "FOUND android/key.properties"
            Get-Content "android/key.properties"
          } else {
            Write-Host "android/key.properties NOT FOUND"
          }
          
          Write-Host "Checking keystore..."
          if (Test-Path "android/keystores/cicd-keystore.jks") {
            Write-Host "Keystore FOUND"
          } else {
            Write-Host "Keystore NOT FOUND"
          }
      # -----------------------------
      # Build one format based on input
      # -----------------------------
      - name: Build signed release APK (selected)
        if: ${{ inputs.build_format == 'apk' }}
        shell: powershell
        env:
          DART_DEFINE: ${{ inputs.dart_define }}
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          $extra = ""
          if ($env:DART_DEFINE -ne "") {
            $env:DART_DEFINE.Split(",") | ForEach-Object {
              if ($_ -ne "") { $extra += " --dart-define=$_" }
            }
          }
          flutter build apk --release $extra
          
          $apk = "build/app/outputs/flutter-apk/app-release.apk"
          if (!(Test-Path $apk)) {
          Write-Error "❌ APK not found at $apk"
          Get-ChildItem -Recurse build | Select-Object FullName, Length | Format-Table -AutoSize
          exit 1
          }
          "ARTIFACT_PATH=$apk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARTIFACT_NAME=android-apk-${{ env.APP_VERSION }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build signed release AAB (selected)
        if: ${{ inputs.build_format == 'aab' }}
        shell: powershell
        env:
          DART_DEFINE: ${{ inputs.dart_define }}
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          $extra = ""
          if ($env:DART_DEFINE -ne "") {
            $env:DART_DEFINE.Split(",") | ForEach-Object {
              if ($_ -ne "") { $extra += " --dart-define=$_" }
            }
          }
          flutter build appbundle --release $extra
          
          $aab = "build/app/outputs/bundle/release/app-release.aab"
          if (!(Test-Path $aab)) {
            Write-Error "❌ AAB not found at $aab"
            Get-ChildItem -Recurse build | Select-Object FullName, Length | Format-Table -AutoSize
            exit 1
          }
          "ARTIFACT_PATH=$aab" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARTIFACT_NAME=android-aab-${{ env.APP_VERSION }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # -----------------------------
      # Upload selected artifact
      # -----------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          if-no-files-found: error