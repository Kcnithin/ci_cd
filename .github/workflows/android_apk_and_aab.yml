name: Android - Build Signed (APK or AAB) - Windows

on:
  workflow_dispatch:
    inputs:
      build_format:
        description: "Choose build output: apk or aab"
        required: true
        default: "apk"
      bump_strategy:
        description: "Version bump strategy: build (default), patch, minor, major"
        required: true
        default: "build"
      dart_define:
        description: "Optional --dart-define key=value (comma-separated). Example: ENV=prod,FOO=bar"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build-android:
    runs-on: windows-latest
    name: Build Signed ${{ inputs.build_format }} on Windows

    env:
      PACKAGE_NAME: "com.example.sample_ci_cd"

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set up Java 17 (AGP compatible)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Flutter 3.38.9
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: stable

      - name: Flutter clean
        shell: powershell
        run: flutter clean

      - name: Flutter pub get
        shell: powershell
        run: flutter pub get

      - name: Ensure android folder exists
        shell: powershell
        run: |
          if (-not (Test-Path "android/app/build.gradle") -and -not (Test-Path "android/app/build.gradle.kts")) {
            flutter create .
          }

      # -----------------------------
      # Auto version bump in pubspec.yaml
      # -----------------------------
      - name: Auto bump version (versionName & versionCode)
        shell: powershell
        env:
          BUMP_STRATEGY: ${{ inputs.bump_strategy }}
        run: |
          $pub = "pubspec.yaml"
          if (!(Test-Path $pub)) { Write-Error "pubspec.yaml not found"; exit 1 }

          $content = Get-Content -Raw -Path $pub
          $regex = [regex]'(?m)^\s*version:\s*([0-9]+)\.([0-9]+)\.([0-9]+)(?:\+([0-9]+))?\s*$'

          if (-not $regex.IsMatch($content)) {
            Write-Error "version: x.y.z(+build) not found in pubspec.yaml"
            exit 1
          }

          $m = $regex.Match($content)
          $maj = [int]$m.Groups[1].Value
          $min = [int]$m.Groups[2].Value
          $pat = [int]$m.Groups[3].Value
          $code = if ($m.Groups[4].Success) { [int]$m.Groups[4].Value } else { 0 }

          switch ($env:BUMP_STRATEGY) {
            'major' { $maj++; $min=0; $pat=0 }
            'minor' { $min++; $pat=0 }
            'patch' { $pat++ }
            default  { } # 'build' -> do not change x.y.z
          }

          $code++

          $newVersion = "{0}.{1}.{2}+{3}" -f $maj, $min, $pat, $code
          $newContent = $regex.Replace($content, "version: $newVersion")

          $newContent | Set-Content -Path $pub -Encoding UTF8

          "APP_VERSION=$newVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Bumped version to: $newVersion"

      # -----------------------------
      # Signing setup (Upload keystore)
      # -----------------------------
      - name: Decode & save keystore
        shell: powershell
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          New-Item -ItemType Directory -Force -Path "android\keystores" | Out-Null
          $bytes = [Convert]::FromBase64String($env:ANDROID_KEYSTORE_BASE64)
          [IO.File]::WriteAllBytes("android\keystores\cicd-keystore.jks", $bytes)
          Get-ChildItem "android\keystores"

      # with storeFile path relative to android/app (module dir)
      - name: Create key.properties at repo root (Kotlin DSL signing)
        shell: powershell
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          $props = @"
          storeFile=../keystores/cicd-keystore.jks
          storePassword=$env:ANDROID_KEYSTORE_PASSWORD
          keyAlias=$env:ANDROID_KEY_ALIAS
          keyPassword=$env:ANDROID_KEY_ALIAS_PASSWORD
          "@
                  # The file must be at the repository root
                  $props | Set-Content -Path "key.properties" -Encoding UTF8
          Write-Host "Wrote key.properties at repo root"

      # -----------------------------
      # Build one format based on input
      # -----------------------------
      - name: Build signed release APK (selected)
        if: ${{ inputs.build_format == 'apk' }}
        shell: powershell
        env:
          DART_DEFINE: ${{ inputs.dart_define }}
        run: |
          $extra = ""
          if ($env:DART_DEFINE -ne "") {
            $env:DART_DEFINE.Split(",") | ForEach-Object {
              if ($_ -ne "") { $extra += " --dart-define=$_" }
            }
          }
          flutter build apk --release $extra
          
          $apk = "build/app/outputs/flutter-apk/app-release.apk"
          if (!(Test-Path $apk)) {
          Write-Error "❌ APK not found at $apk"
          Get-ChildItem -Recurse build | Select-Object FullName, Length | Format-Table -AutoSize
          exit 1
          }
          "ARTIFACT_PATH=$apk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARTIFACT_NAME=android-apk-${{ env.APP_VERSION }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build signed release AAB (selected)
        if: ${{ inputs.build_format == 'aab' }}
        shell: powershell
        env:
          DART_DEFINE: ${{ inputs.dart_define }}
        run: |
          $extra = ""
          if ($env:DART_DEFINE -ne "") {
            $env:DART_DEFINE.Split(",") | ForEach-Object {
              if ($_ -ne "") { $extra += " --dart-define=$_" }
            }
          }
          flutter build appbundle --release $extra
          
          $aab = "build/app/outputs/bundle/release/app-release.aab"
          if (!(Test-Path $aab)) {
            Write-Error "❌ AAB not found at $aab"
            Get-ChildItem -Recurse build | Select-Object FullName, Length | Format-Table -AutoSize
            exit 1
          }
          "ARTIFACT_PATH=$aab" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ARTIFACT_NAME=android-aab-${{ env.APP_VERSION }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # -----------------------------
      # Upload selected artifact
      # -----------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          if-no-files-found: error